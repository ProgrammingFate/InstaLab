{% extends 'base.html' %}
{% load static %}

{% block title %}Chat com {{ other_user.nickname }} - InstaLab{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        height: 80vh;
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px 20px 0 0;
    }
    
    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        max-height: 60vh;
    }
    
    .chat-input {
        padding: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        border-radius: 0 0 20px 20px;
    }
    
    .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-end;
    }
    
    .message.sent {
        justify-content: flex-end;
    }
    
    .message.received {
        justify-content: flex-start;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 12px 18px;
        border-radius: 20px;
        position: relative;
        word-wrap: break-word;
    }
    
    .message.sent .message-bubble {
        background: linear-gradient(45deg, #6A5ACD, #9370DB);
        color: white;
        border-bottom-right-radius: 5px;
    }
    
    .message.received .message-bubble {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border-bottom-left-radius: 5px;
    }
    
    .message-time {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 5px;
    }
    
    .user-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: linear-gradient(45deg, #6A5ACD, #9370DB);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
        margin: 0 10px;
    }
    
    .message-input {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 25px;
        padding: 12px 20px;
        color: white;
        width: 100%;
    }
    
    .message-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }
    
    .btn-send {
        background: linear-gradient(45deg, #6A5ACD, #9370DB);
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        color: white;
        margin-left: 10px;
        transition: all 0.3s ease;
    }
    
    .btn-send:hover {
        transform: scale(1.1);
        color: white;
    }
    
    .back-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        color: white;
        margin-right: 15px;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .back-btn:hover {
        background: rgba(106, 90, 205, 0.3);
        color: white;
        transform: translateX(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="chat-container">
                <!-- Header -->
                <div class="chat-header">
                    <div class="d-flex align-items-center">
                        <a href="{% url 'messaging:conversations_list' %}" class="back-btn">
                            ‚Üê
                        </a>
                        
                        <div class="user-avatar me-3">
                            {% if other_user.profile_picture %}
                                <img src="{{ other_user.profile_picture.url }}" alt="{{ other_user.nickname }}" 
                                     style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover;">
                            {% else %}
                                {{ other_user.nickname|first|upper }}
                            {% endif %}
                        </div>
                        
                        <div>
                            <h5 class="text-white mb-0">{{ other_user.nickname }}</h5>
                            <small class="text-white-50">
                                {% if other_user.user_type == 'company' %}
                                    üè¢ {{ other_user.company_name|default:"Empresa" }}
                                {% else %}
                                    üéì {{ other_user.course|default:"Estudante" }}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Messages -->
                <div class="chat-messages" id="chat-messages">
                    {% for message in messages %}
                        <div class="message {% if message.sender == user %}sent{% else %}received{% endif %}">
                            {% if message.sender != user %}
                                <div class="user-avatar">
                                    {% if message.sender.profile_picture %}
                                        <img src="{{ message.sender.profile_picture.url }}" alt="{{ message.sender.nickname }}" 
                                             style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover;">
                                    {% else %}
                                        {{ message.sender.nickname|first|upper }}
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                            <div class="message-content">
                                <div class="message-bubble">
                                    {{ message.content }}
                                </div>
                                <div class="message-time text-center">
                                    {{ message.timestamp|date:"H:i" }}
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="text-center py-5">
                            <div class="mb-3" style="font-size: 3rem;">üëã</div>
                            <h5 class="text-white mb-2">Comece a conversa!</h5>
                            <p class="text-white-50">Envie a primeira mensagem para {{ other_user.nickname }}</p>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Input -->
                <div class="chat-input">
                    <form method="post" class="d-flex align-items-center" id="message-form">
                        {% csrf_token %}
                        <input type="text" 
                               name="content" 
                               class="message-input" 
                               placeholder="Digite sua mensagem..." 
                               autocomplete="off"
                               required>
                        <button type="submit" class="btn btn-send">
                            ‚û§
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('chat-messages');
    const messageForm = document.getElementById('message-form');
    
    // Scroll para a √∫ltima mensagem
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Auto-scroll quando novas mensagens chegarem
    const observer = new MutationObserver(function(mutations) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
    
    observer.observe(messagesContainer, { childList: true });
    
    // Focus no input
    document.querySelector('.message-input').focus();
    
    // Enter para enviar
    document.querySelector('.message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            messageForm.submit();
        }
    });
});
</script>
{% endblock %}